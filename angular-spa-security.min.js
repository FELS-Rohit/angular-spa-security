angular.module("security",[]).constant("security.urls",{site:"/",manage:"/manage",join:"/api/account/register",login:"/token",logout:"/api/account/logout",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",manageInfo:"/api/account/manageInfo",registerExternal:"/api/account/registerExternal",addExternalLogin:"/api/account/addExternalLogin",removeLogin:"/api/account/removeLogin"}).factory("security.api",["$http","security.urls",function(e,t){var n={"Content-Type":"application/x-www-form-urlencoded"};var r=function(e){var t=function(e){var n="";var r,i,s,o;angular.forEach(e,function(e,u){if(e instanceof Array){for(o=0;o<e.length;++o){r=e[o];i=u+"["+o+"]";s={};s[i]=r;n+=t(s)+"&"}}else if(e instanceof Object){angular.forEach(e,function(e,r){i=u+"["+r+"]";s={};s[i]=e;n+=t(s)+"&"})}else if(e!==undefined&&e!==null){n+=encodeURIComponent(u)+"="+encodeURIComponent(e)+"&"}});return n.length?n.substr(0,n.length-1):n};return angular.isObject(e)&&String(e)!=="[object File]"?t(e):e};var i={getUserInfo:function(n){return e({url:t.userInfo,method:"GET",headers:{Authorization:"Bearer "+n}})},login:function(i){return e({method:"POST",url:t.login,data:r(i),headers:n})},logout:function(){return e({method:"POST",url:t.logout})},register:function(n){return e({method:"POST",url:t.join,data:n})},changePassword:function(n){return e({method:"POST",url:t.changePassword,data:n})},getExternalLogins:function(){return e({method:"GET",url:t.externalLogins+"?returnUrl="+encodeURIComponent(t.site)+"&generateState=true",isArray:true})},manageInfo:function(){return e({method:"GET",url:t.manageInfo+"?returnUrl="+encodeURIComponent(t.site)+"&generateState=false"})},registerExternal:function(n,r){return e({method:"POST",url:t.registerExternal,data:r,headers:{Authorization:"Bearer "+n}})},addExternalLogin:function(n,r){return e({method:"POST",url:t.addExternalLogin,data:{externalAccessToken:r},headers:{Authorization:"Bearer "+n}})},removeLogin:function(n){return e({method:"POST",url:t.removeLogin,data:n})}};return i}]).provider("security",["security.urls",function(e){var t=this;t.registerThenLogin=true;t.usePopups=false;t.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"};t.apiUrls=e;t.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};t.$get=["security.api","$q","$http","$location","$timeout",function(e,n,r,i,s){var o=null;var u=function(e){var t={},n,r,i,s,o,u,a;if(e===null){return t}n=e.split("&");for(var f=0;f<n.length;f++){r=n[f];i=r.indexOf("=");if(i===-1){s=r;o=null}else{s=r.substr(0,i);o=r.substr(i+1)}u=decodeURIComponent(s);a=decodeURIComponent(o);t[u]=a}return t};var a=function(e,t){if(e){if(e=="clear"){localStorage.removeItem("accessToken");sessionStorage.removeItem("accessToken");delete r.defaults.headers.common.Authorization}else{if(t)localStorage.accessToken=e;else sessionStorage.accessToken=e;r.defaults.headers.common.Authorization="Bearer "+e}}return sessionStorage.accessToken||localStorage.accessToken};var f=function(e){if(e=="clear"){delete localStorage.associating;return}if(e)localStorage.associating=e;return localStorage.associating};var l=function(e){if(e=="clear"){delete localStorage.redirectTarget;return}if(e)localStorage.redirectTarget=e;return localStorage.redirectTarget};var c=function(r,s,o){var u=n.defer();if(r.error){u.reject({message:r.error})}else{if(a()&&f()){f("clear");l("clear");e.addExternalLogin(a(),r.access_token).success(function(){u.resolve()})}else{e.getUserInfo(r.access_token).success(function(e){if(e.hasRegistered){a(r.access_token,o);p.user=e;p.redirectAuthenticated(l()||t.urls.home);if(t.events.login)t.events.login(p,e);u.resolve(p.user)}else{p.externalUser=e;p.externalUser.access_token=r.access_token;p.externalUser.provider=s;if(o!=null)localStorage.rememberMe=o;i.path(t.urls.registerExternal);u.reject()}})}}return u.promise};var h=function(){if(i.path().indexOf("access_token")!=-1){var n=u(i.path().substring(1));if(window.opener){window.opener.external_data=n;window.close()}else{var r=l();i.path(r||t.urls.home);var s=JSON.parse(localStorage.loginProvider);var o=false;if(localStorage.rememberMe){o=JSON.parse(localStorage.rememberMe);delete localStorage.rememberMe}delete localStorage.loginProvider;c(n,s,o)}}if(a()){a(a());e.getUserInfo(a()).success(function(e){p.user=e;if(t.events.reloadUser)t.events.reloadUser(p,e)})}e.getExternalLogins().success(function(e){p.externalLogins=e})};var p=this;p.user=null;p.externalUser=null;p.externalLogins=[];p.login=function(r){var i=n.defer();r.grant_type="password";e.login(r).success(function(e){a(e.access_token,r.rememberMe);p.user=e;p.redirectAuthenticated(l()||t.urls.home);if(t.events.login)t.events.login(p,e);i.resolve(p.user)}).error(function(e){i.reject(e)});return i.promise};p.loginWithExternal=function(e,r){var i=n.defer();if(t.usePopups){var u=window.open(e.url,"frame","resizeable,height=510,width=380");s.cancel(o);o=s(function a(){if(!u.closed){o=s(a,500);return}if(t.events.closeOAuthWindow)t.events.closeOAuthWindow(p,window.external_data);if(typeof window.external_data==="undefined"){i.reject();return}var n=window.external_data;delete window.external_data;i.resolve(c(n,e,r.rememberMe))},500)}else{if(r!=null&&r.rememberMe!=null)localStorage.rememberMe=JSON.stringify(r.rememberMe);localStorage.loginProvider=JSON.stringify(e);window.location.href=e.url}return i.promise};p.logout=function(){var r=n.defer();e.logout().success(function(){p.user=null;a("clear");l("clear");if(t.events.logout)t.events.logout(p);i.path(t.urls.postLogout);r.resolve()}).error(function(e){r.reject(e)});return r.promise};p.register=function(r){var i=n.defer();e.register(r).success(function(){if(t.events.register)t.events.register(p);if(t.registerThenLogin){p.login(r).then(function(e){i.resolve(e)},function(e){i.reject(e)})}else{i.resolve()}}).error(function(e){i.reject(e)});return i.promise};p.registerExternal=function(){var t=n.defer();if(!p.externalUser){t.reject()}else{e.registerExternal(p.externalUser.access_token,p.externalUser).success(function(){t.resolve(p.loginWithExternal(p.externalUser.provider));p.externalUser=null}).error(function(e){t.reject(e)})}return t.promise};p.mangeInfo=function(){var t=n.defer();e.manageInfo().success(function(e){t.resolve(e)}).error(function(e){t.reject(e)});return t.promise};p.changePassword=function(t){var r=n.defer();e.changePassword(t).success(function(){r.resolve()}).error(function(e){r.reject(e)});return r.promise};p.addExternalLogin=function(t,r){var i=n.defer();e.addExternalLogin(t,r).success(function(){i.resolve()}).error(function(e){i.reject(e)});return i.promise};p.associateExternal=function(e,r){var i=n.defer();if(t.usePopups){var u=window.open(e.url,"frame","resizeable,height=510,width=380");s.cancel(o);o=s(function a(){if(!u.closed){o=s(a,500);return}if(t.events.closeOAuthWindow)t.events.closeOAuthWindow(p,window.external_data);if(typeof window.external_data==="undefined"){i.reject();return}var n=window.external_data;delete window.external_data;i.resolve(c(n,e,data.rememberMe))},500)}else{localStorage.loginProvider=JSON.stringify(e);f(true);l(r||"/");window.location.href=e.url}return i.promise};p.removeLogin=function(t){var r=n.defer();e.removeLogin(t).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)});return r.promise};p.authenticate=function(){if(a())return;if(!l())l(i.path());i.path(t.urls.login)};p.redirectAuthenticated=function(e){if(!a())return;if(l())l("clear");i.path(e)};h();return p}]}])