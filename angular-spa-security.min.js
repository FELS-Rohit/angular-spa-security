angular.module("security",[]).constant("security.urls",{site:"/",join:"/api/account/register",login:"/token",logout:"/api/account/logout",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",registerExternal:"/api/account/registerExternal"}).factory("security.api",["$http","security.urls",function(e,t){var n={"Content-Type":"application/x-www-form-urlencoded"};var r=function(e){var t=function(e){var n="";var r,i,s,o;angular.forEach(e,function(e,u){if(e instanceof Array){for(o=0;o<e.length;++o){r=e[o];i=u+"["+o+"]";s={};s[i]=r;n+=t(s)+"&"}}else if(e instanceof Object){angular.forEach(e,function(e,r){i=u+"["+r+"]";s={};s[i]=e;n+=t(s)+"&"})}else if(e!==undefined&&e!==null){n+=encodeURIComponent(u)+"="+encodeURIComponent(e)+"&"}});return n.length?n.substr(0,n.length-1):n};return angular.isObject(e)&&String(e)!=="[object File]"?t(e):e};var i={getUserInfo:function(n){return e({url:t.userInfo,method:"GET",headers:{Authorization:"Bearer "+n}})},login:function(i){return e({method:"POST",url:t.login,data:r(i),headers:n})},logout:function(){return e({method:"POST",url:t.logout})},register:function(n){return e({method:"POST",url:t.join,data:n})},changePassword:function(n){return e({method:"POST",url:t.changePassword,data:n})},getExternalLogins:function(){return e({method:"GET",url:t.externalLogins+"?returnUrl="+encodeURIComponent(t.site)+"&generateState=true",isArray:true})},registerExternal:function(n,r){return e({method:"POST",url:t.registerExternal,data:r,headers:{Authorization:"Bearer "+n}})}};return i}]).provider("security",["security.urls",function(e){var t=this;t.registerThenLogin=true;t.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"};t.apiUrls=e;t.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};t.$get=["security.api","$q","$http","$location","$timeout",function(e,n,r,i,s){var o=null;var u=null;var a=function(e){var t={},n,r,i,s,o,u,a;if(e===null){return t}n=e.split("&");for(var f=0;f<n.length;f++){r=n[f];i=r.indexOf("=");if(i===-1){s=r;o=null}else{s=r.substr(0,i);o=r.substr(i+1)}u=decodeURIComponent(s);a=decodeURIComponent(o);t[u]=a}return t};var f=function(e,t){if(e){if(e=="clear"){localStorage.removeItem("accessToken");sessionStorage.removeItem("accessToken");delete r.defaults.headers.common.Authorization}else{if(t)localStorage.accessToken=e;else sessionStorage.accessToken=e;r.defaults.headers.common.Authorization="Bearer "+e}}return sessionStorage.accessToken||localStorage.accessToken};var l=function(){if(i.path().indexOf("access_token")!=-1){window.opener.external_data=a(i.path().substring(1));window.close()}if(f()){f(f());e.getUserInfo(f()).success(function(e){c.user=e;if(t.events.reloadUser)t.events.reloadUser(c,e)})}e.getExternalLogins().success(function(e){c.externalLogins=e})};var c=this;c.user=null;c.externalUser=null;c.externalLogins=[];c.login=function(r){var i=n.defer();r.grant_type="password";e.login(r).success(function(e){f(e.access_token,r.rememberMe);c.user=e;c.redirectAuthenticated(o||t.urls.home);if(t.events.login)t.events.login(c,e);i.resolve(c.user)}).error(function(e){i.reject(e)});return i.promise};c.loginWithExternal=function(r){var a=n.defer();var l=window.open(r.url,"frame","resizeable,height=510,width=380");s.cancel(u);u=s(function h(){if(!l.closed){u=s(h,500);return}if(t.events.closeOAuthWindow)t.events.closeOAuthWindow(c,window.external_data);if(typeof window.external_data==="undefined"){a.reject();return}var n=window.external_data;delete window.external_data;if(n.error){a.reject({message:n.error});return}e.getUserInfo(n.access_token).success(function(e){if(e.hasRegistered){f(n.access_token);c.user=e;c.redirectAuthenticated(o||t.urls.home);if(t.events.login)t.events.login(c,e);a.resolve(c.user)}else{c.externalUser=e;c.externalUser.access_token=n.access_token;c.externalUser.provider=r;i.path(t.urls.registerExternal);a.reject()}})},500);return a.promise};c.logout=function(){var r=n.defer();e.logout().success(function(){c.user=null;f("clear");o=null;if(t.events.login)t.events.logout(c);i.path(t.urls.postLogout);r.resolve()}).error(function(e){r.reject(e)});return r.promise};c.register=function(r){var i=n.defer();e.register(r).success(function(){if(t.events.register)t.events.register(c);if(t.registerThenLogin){c.login(r).then(function(e){i.resolve(e)},function(e){i.reject(e)})}else{i.resolve()}}).error(function(e){i.reject(e)});return i.promise};c.registerExternal=function(){var t=n.defer();if(!c.externalUser){t.reject()}else{e.registerExternal(c.externalUser.access_token,c.externalUser).success(function(){t.resolve(c.loginWithExternal(c.externalUser.provider));c.externalUser=null}).error(function(e){t.reject(e)})}return t.promise};c.changePassword=function(t){var r=n.defer();e.changePassword(t).success(function(){r.resolve()}).error(function(e){r.reject(e)});return r.promise};c.authenticate=function(){if(f())return;o=i.path();i.path(t.urls.login)};c.redirectAuthenticated=function(e){if(!f())return;i.path(e)};l();return c}]}])